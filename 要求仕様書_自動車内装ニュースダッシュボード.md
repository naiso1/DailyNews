# 要求仕様書：自動車内装製品デイリーニュース・ダッシュボード運用システム

---

## 1. 文書情報
* **文書名**：自動車内装製品デイリーニュース・ダッシュボード運用更新システム 要求仕様書
* **作成日**：2025年12月14日
* **最終更新日**：2025年12月22日
* **対象プロジェクト**：内装製品デイリーニュース.html
* **版数**：Ver. 4.0

---

## 2. プロジェクト概要
本プロジェクトは、日本・中国・インドを中心とした「自動車内装製品」に関する最新ニュースを日次で収集し、閲覧・検索・分析が可能なWebダッシュボード（`内装製品デイリーニュース.html`）を運用することを目的とする。
ユーザーは最新のニュース情報をテキスト形式で提供するだけで、システム（AIおよびスクリプト）が半自動的にHTMLを更新し、画像取得・整形を行う運用フローを構築する。

---

## 3. システム機能要件

### 3.1 ダッシュボード（フロントエンド）機能
* **デザイン・UI**:
    * **ダークモード基調**: 暗色背景にネオンカラー（アクセント）を用いたモダンでプレミアムなデザイン。
    * **レスポンシブ対応**: PCおよびモバイル端末で見やすいグリッドレイアウトを採用。
* **フィルタリング・検索機能**:
    * **国別フィルタ**: 「日本」「中国」「インド」「世界版」の切り替えが可能。国旗アイコン（CSS描画）を使用し、OS依存の表示崩れを防ぐ。
    * **タグフィルタ**: `HMI`, `プレミアム`, `加飾` 等のタグによる絞り込み。
    * **日付フィルター**: 開始日・終了日を指定した期間絞り込み。
    * **キーワード検索**: タイトル、概要、タグ等を対象としたリアルタイムフィルタリング。
    * **ソート機能**: 
        * 日付の「新しい順」「古い順」切り替え
        * 「いいね数」「コメント数」による並び替え（Firebase連携）
* **ニュースカード表示**:
    * 各ニュースをカード形式で表示（サムネイル画像、タイトル、概要、国旗バッジ、日付、ソース元リンク）。
    * **詳細要約開閉**: 「詳細要約を見る」ボタンによるアコーディオン表示。
    * **画像注釈**: 
        * 画像上に「※イメージ画像」注釈を表示（Unsplash等のプレースホルダー画像使用時に自動表示）
        * **note欄での注釈表記**: `note` フィールドに「※イメージ画像／」を含める形式で明示的に表示
    * **インタラクション機能**:
        * いいねボタン（ハートアイコン）: オプティミスティックUIで即座にカウント反映
        * コメント機能: 記事ごとにコメント投稿・表示が可能
* **インサイト（考察・アイデア）セクション**:
    * **考察 (Analysis)**: 国ごとにカード化されたグリッドレイアウト。重要キーワードは太字・背景色でハイライト表示。
    * **企画アイデア (Ideas)**: 国ごとにセクション分割。各アイデアは画像とテキストを横並びにしたリッチなカードデザインで表示。
    * **画像連動**: 企画アイデアにはAI生成されたコンセプト画像（`images/` フォルダ参照）を表示。
    * **ID管理**: アイデアIDは日付順に連番で管理（古い日付から新しい日付へ1から順番に採番）

### 3.2 データ管理・バックエンド機能
* **データ構造の分離**:
    * `news_data.js`: ニュース記事本体データ。
    * `insights_data.js`: 考察および企画アイデアのデータ。
* **Firebase連携**:
    * Firestore を使用したいいね・コメントデータの永続化
    * `interactions` コレクションでの管理
* **画像生成・管理**:
    * 企画アイデア用のコンセプト画像をAIにより生成し、ローカルの `images/` フォルダで管理。
    * スクリプトにより自動的にリネーム・フォルダ移動を行う運用。

---

## 4. 運用ワークフロー（Update Workflow）

### 【Step 0】 画像レビュー用データ生成と選択
1. `python prepare_review_data.py` を実行し、対象日付（現状は 2025-12-18〜21）の記事から画像候補を収集して `review_data.json` を生成する。
2. `review_interior.html` をローカルHTTPサーバ（例: `python -m http.server 8000`）経由で開き、現行画像と候補画像を並べて比較する。`file://` で開く場合は画面上の「JSONを読み込む」で `review_data.json` を手動指定する。
3. 差し替えたい候補を選択し、JSON/CSV をクリップボードにコピーする。
4. その選択JSONを `apply_selected_images.py` の `SELECTED` に貼り付け、`python apply_selected_images.py` で `news_data.js` の `img` を一括更新する（空文字はスキップ）。

### 【Step 1】 データの追加
ユーザーから提供されたニュース情報、またはAIが収集した情報を元に、以下のデータを更新する。
1. `news_data.js`: ニュース記事情報の追加。
2. `insights_data.js`: 日次の考察と、それに基づく企画アイデアの記述を追加。

**日本語化原則**: 
* 中国語・英語などの原文ニュースのタイトル、説明、タグはすべて日本語に翻訳して記載する
* 企業名・製品名は適切なカタカナ表記または原語を使用

### 【Step 2】 記事画像の取得
各ニュース記事の画像を以下の優先順位で取得する：
1. **記事ページからの直接抽出**: HTMLソースから`og:image`、`data-src`、`src`属性を正規表現で抽出。
2. **ブラウザ操作による取得**: 動的サイトの場合はブラウザサブエージェントを使用してJavaScript実行後のDOM解析。
3. **ユーザー指定URL**: ユーザーが直接画像URLを提供した場合はそれを使用。
4. **プレースホルダー画像**: 取得不可の場合はUnsplash等の汎用画像を使用し、「※イメージ画像」注釈を表示。

**画像選択基準**:
* **車内インテリア画像を優先**: ダッシュボード、コックピット、シート等の内装画像を最優先
* 外装画像しか取得できない場合は外装画像を使用
* 画像が見つからない場合は `note` 欄に「※イメージ画像／」を付与

### 【Step 3】 アイデア画像の生成と配置
企画アイデア（`insights_data.js` 内の `ideas`）に対応するコンセプト画像をAI生成ツールを用いて作成する。
* 生成された画像はタイムスタンプ付きのファイル名から、簡潔な名前にリネーム（例: `jp_compact_hmi_1214.png`）。
* 画像ファイルは `images/` フォルダに格納する。
* 命名規則: `{国コード}_{内容}_{日付}.png`（例: `cn_wellness_console_1214.png`）

### 【Step 4】 ファイルパスの更新
`news_data.js` および `insights_data.js` 内の画像パスを `images/ファイル名.png` に更新し、HTML側で正しく読み込めるようにする。

---

## 5. 画像取得仕様

### 5.1 記事画像の取得ロジック
* **HTMLソースからの抽出**:
  * `og:image` メタタグ → 最優先
  * `data-src` / `data-original` 属性 → 遅延読み込み画像用
  * `src` 属性 → 通常の画像タグ
  * プロトコル相対URL（`//`で始まるもの）にも対応
* **フィルタリング**:
  * `logo`, `icon`, `avatar`, `ad`, `banner` を含むURLは除外
  * 5KB未満の小さなファイルは除外
* **サイト別対応**:
  * Sohu: `q*.itc.cn` ドメインの画像
  * PCAuto: `img*.pcauto.com.cn` ドメインの画像
  * Sina: `n.sinaimg.cn` ドメインの画像
  * DTM: `www.dtm.com.cn/file/upload/` パスの画像
  * 腾讯新闻: `inews.gtimg.com` ドメインの画像
  * IT之家: `img.ithome.com` ドメインの画像
  * 汽車之家: `www*.autoimg.cn` ドメインの画像

### 5.2 「※イメージ画像」注釈表示条件
* 画像URLに `unsplash` または `placeholder` が含まれる場合に自動表示
* `note` フィールドに「※イメージ画像」が含まれる場合に表示
* ローカルに保存された実記事画像には表示されない

---

## 6. これまでの実装・改修履歴

| 実装日 | 内容 | 詳細 |
|:---|:---|:---|
| 初期 | ダッシュボード構築 | 3カ国対応、フィルタリング、検索機能の実装。 |
| 12/04 | 中国ニュース追加 | Xiaomi、BYD等の中国市場ニュース追加。 |
| 12/10 | インドニュース追加 | Kia Seltos発表などインド市場ニュース追加。 |
| 12/12 | 画像取得ロジック改善 | 記事内画像の優先取得、リンク切れ対応、注釈機能。 |
| 12/14 | **UI/UX大幅刷新** | 考察・アイデア欄のレイアウト改善（カード化、ハイライト）。CSS国旗アイコン実装。 |
| 12/14 | **画像生成連携** | 企画アイデアの画像をAI生成し、`images/` フォルダでローカル管理する仕組みを導入。 |
| 12/14 | **日付フィルタ改善** | 日付範囲指定フィルターの実装。 |
| 12/15 | **中国ニュース (cn41-cn50) 大幅更新** | 記事内容の全面更新、URL修正、画像再取得。 |
| 12/15 | **cn42記事削除** | autohome.com.cn の極氪8X記事を削除（URLエラー）。 |
| 12/15 | **URL変更対応** | cn41→dayoo.com、cn43→新pcauto URL、cn45→新sina URLに変更。 |
| 12/15 | **画像抽出ロジック強化** | 正規表現を改良し、`data-src`、プロトコル相対URLにも対応。 |
| 12/15 | **2025-12-14 企画アイデア画像生成** | 中国・日本・インド各2件、計6件のコンセプト画像をAI生成。 |
| 12/17 | **Firebase連携追加** | いいね・コメント機能のためにFirebase Firestoreを導入。 |
| 12/17 | **ソート機能拡張** | いいね数・コメント数による並び替え機能を追加。 |
| 12/17 | **ドロップダウン視認性改善** | ソート順ドロップダウンのダーク背景・白文字スタイルを適用。 |
| 12/18 | **2025-12-17 ニュース追加** | 日本10件、中国10件、インド10件の計30件を追加。 |
| 12/18 | **インサイトID連番化** | 全日付のアイデアIDを1〜38まで日付順に再番号付け。 |
| 12/18 | **insights_data.js構文修正** | エスケープされていないダブルクォートによる構文エラーを全面修正。 |
| 12/18 | **オプティミスティックUI実装** | いいねボタンの即時反映（サーバー応答前にUI更新）を実装。 |
| 12/22 | **2025-12-18〜21 日本ニュース追加** | jp80〜jp88の9件を追加。 |
| 12/22 | **2025-12-18〜21 中国ニュース追加** | cn51〜cn60の10件を追加（零跑D19、昊铂A800、智趣烈馬 等）。 |
| 12/22 | **2025-12-18〜21 インドニュース追加** | in71〜in80の10件を追加（ZF静粛化技術、XUV 7XO、Gravite 等）。 |
| 12/22 | **2025-12-18 考察・アイデア追加** | 日本・中国・インド各2件、計6件のアイデアとAI画像を追加（ID 37〜42）。 |
| 12/22 | **画像URL検証・修正** | cn53（昊铂A800）、cn59（零跑D19）の画像URLを正しい内装画像に更新。 |
| 12/22 | **イメージ画像注釈追加** | cn56（安通林）に「※イメージ画像」表記を追加。 |
| 12/22 | **画像レビュー／反映フロー追加** | `prepare_review_data.py` で候補収集、`review_interior.html` で新旧比較と選択、`apply_selected_images.py` で `news_data.js` の `img` を一括更新。jp80/jp82/jp83/jp84/jp88/cn52/cn54/cn55/cn56/cn57/cn60/in75/in78 を差し替え。 |

---

## 7. 技術仕様・ファイル構成

* **メインファイル**: `内装製品デイリーニュース.html`
* **データファイル**: 
    * `news_data.js`: ニュース記事リスト
    * `insights_data.js`: 考察・アイデアリスト
* **リソース**: `images/` フォルダ（ローカル画像格納用）
* **補助スクリプト（Python）**:
    * 画像取得スクリプト: 正規表現によるHTML解析、SSL対応
    * パス更新スクリプト: データファイルの画像パス一括更新
    * `robust_scrape_cn.py`: 中国サイト用の堅牢なスクレイピングスクリプト
    * `prepare_review_data.py`: 記事URLから画像候補を収集し `review_data.json` を生成
    * `apply_selected_images.py`: 選択JSONに基づき `news_data.js` の `img` を一括更新
* **外部サービス**:
    * Firebase Firestore: いいね・コメントデータの永続化

* **レビュー用HTML**:
    * `review_interior.html`: `review_data.json` を読み込み、新旧画像を並べて選択しJSON/CSVをコピー。`file://` ではフェッチ不可のため、HTTPサーバ経由または画面ボタンでローカルJSONを読み込む。

### 7.1 画像ファイル命名規則
| 種別 | 命名規則 | 例 |
|:---|:---|:---|
| 記事画像 | `{記事ID}.{拡張子}` | `cn41.jpg`, `jp42.png` |
| 企画アイデア画像 | `{国コード}_{内容}_{日付}.png` | `cn_wellness_console_1214.png` |

### 7.2 データ構造仕様

#### news_data.js
```javascript
{
    id: "jp80",           // ユニークID（国コード + 連番）
    title: "記事タイトル",  // 日本語タイトル
    desc: "記事概要",       // 日本語での概要説明
    url: "https://...",    // 元記事URL
    source: "ソース名",     // 出典サイト名
    date: "2025-12-18",    // YYYY-MM-DD形式
    tags: ["タグ1", "タグ2"], // 日本語タグ配列
    country: "jp",         // jp / cn / in
    img: "画像URL",        // 画像パスまたはURL
    note: "補足"           // カード上の補足表示（※イメージ画像表記等）
}
```

#### insights_data.js
```javascript
{
    date: "2025-12-18",
    analysis: {
        jp: "日本市場の考察...",
        cn: "中国市場の考察...",
        in: "インド市場の考察..."
    },
    ideas: {
        jp: [
            { id: 37, img: "images/...", title: "タイトル", desc: "説明" }
        ],
        cn: [...],
        in: [...]
    }
}
```

---

## 8. 運用上の注意事項

### 8.1 記事URLについて
* 中国系ニュースサイトは記事の削除・移動が早いため、404エラーが発生しやすい
* 404エラー発生時は代替URLへの変更、または記事削除で対応
* ユーザーから代替URLの提供があった場合は速やかに反映

### 8.2 画像取得について
* 自動取得が困難な場合はブラウザサブエージェントを使用
* 取得不可の場合はUnsplashプレースホルダーを使用し「※イメージ画像」を表示
* 実記事画像が取得できた場合はローカルに保存し、注釈は非表示
* **内装画像を優先**: コックピット、ダッシュボード、シート等の画像を優先取得
* **note欄での明示**: イメージ画像使用時は `note` 欄に「※イメージ画像／説明」の形式で記載

### 8.3 データ整合性
* 記事削除時は `news_data.js` から該当オブジェクトを完全に削除
* ID重複がないよう注意（cn41, cn43, cn44... の連番管理）
* `insights_data.js` のアイデアIDは全日付を通じて連番（古い日付から順に採番）

### 8.4 日本語化ルール
* ニュースタイトル・説明・タグはすべて日本語で記載
* 企業名は適切なカタカナ表記または原語を使用（例：零跑、昊铂、マヒンドラ）
* 技術用語は業界標準の日本語訳を使用（例：アンビエントライト、ゼログラビティシート）

---

## 9. 今後の拡張性
* **自動要約の強化**: URL入力のみからの完全自動アーカイビング。
* **多言語対応**: UIの英語/日本語切り替え機能。
* **CMS化**: 編集作業をブラウザ上で行える管理画面の導入（現在はファイル直接編集）。
* **画像取得の自動化強化**: より多くのサイト形式に対応した汎用スクレイピングロジック。
* **GitHub Pages連携**: 自動デプロイによる公開フローの効率化。
* **ニュース自動収集**: ChatGPTやPerplexityなどのAIを活用した自動ニュース収集ワークフロー。
* **画像判定AI**: 車内/車外画像の自動判定による適切な画像選択。

