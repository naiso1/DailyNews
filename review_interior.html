<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>内装画像レビュー (2025-12-18〜21)</title>
  <style>
    :root {
      --bg: #0c1116;
      --panel: #121922;
      --border: #223040;
      --text: #e8f0f7;
      --sub: #9fb2c7;
      --accent: #4cc3ff;
      --accent-2: #8d7bff;
      --danger: #ff6b6b;
      --muted: #1a2230;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Noto Sans JP", system-ui, -apple-system, sans-serif;
      background: radial-gradient(120% 120% at 10% 20%, rgba(76,195,255,0.08), transparent),
                  radial-gradient(120% 120% at 80% 0%, rgba(141,123,255,0.08), transparent),
                  var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 18px;
    }
    h1 { margin: 0 0 6px 0; font-size: 22px; }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: 6px 0 12px;
    }
    .btn {
      border: 1px solid var(--border);
      background: linear-gradient(135deg, var(--panel), #0f1722);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    .btn:hover { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(76,195,255,0.3); }
    .btn.danger:hover { border-color: var(--danger); color: #ffecec; }
    .meta {
      color: var(--sub);
      font-size: 13px;
    }
    #articles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    .card h3 { margin: 0; font-size: 15px; }
    .info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .info a { color: var(--accent); text-decoration: none; }
    .info a:hover { text-decoration: underline; }
    .badges { display: flex; gap: 6px; flex-wrap: wrap; }
    .badge {
      background: var(--muted);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--sub);
    }
    .images {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .image-block {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: #0f1621;
    }
    .image-block h4 {
      margin: 0 0 6px 0;
      font-size: 13px;
      color: var(--sub);
    }
    .current-img {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0a0f16;
      object-fit: contain;
      max-height: 220px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }
    .candidate {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px;
      background: #0a1018;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 160px;
      position: relative;
      overflow: hidden;
    }
    .candidate img {
      width: 100%;
      border-radius: 6px;
      object-fit: cover;
      max-height: 120px;
      background: #0c1116;
      border: 1px solid #162030;
    }
    .candidate .fallback-text {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      color: #cdd7e6;
      font-weight: 700;
      font-size: 14px;
      background: linear-gradient(135deg, rgba(76,195,255,0.18), rgba(13,21,32,0.9));
      border: 1px dashed var(--border);
      border-radius: 8px;
      text-shadow: 0 1px 4px rgba(0,0,0,0.5);
    }
    label.select {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--sub);
    }
    textarea.note {
      width: 100%;
      min-height: 60px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0a1018;
      color: var(--text);
      padding: 8px;
      resize: vertical;
    }
    .export-box {
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
      background: #0d1520;
    }
    .pill { color: var(--accent-2); }
    .error { color: var(--danger); font-size: 12px; }
    @media (min-width: 900px) {
      .images { grid-template-columns: 1fr 2fr; }
    }
  </style>
</head>
<body>
  <h1>内装画像レビュー (2025-12-18〜21)</h1>
  <div class="meta" id="meta"></div>

  <div class="toolbar">
    <button class="btn" onclick="copySelection()">選択を書き出し (JSONコピー)</button>
    <button class="btn" onclick="exportCsv()">CSVコピー</button>
    <button class="btn" onclick="toggleNoCandidates()">候補なしを表示/非表示</button>
    <button class="btn" onclick="document.getElementById('fileInput').click()">JSONを読み込む</button>
    <input id="fileInput" type="file" accept=".json" style="display:none" onchange="loadFromFile(this.files)">
    <div class="meta" id="counter"></div>
  </div>

  <div id="status" class="meta"></div>

  <div id="articles"></div>

  <div class="export-box">
    <div class="meta">コピーされる内容: <span class="pill">{"id","selected","note"}</span>（selectedが空なら現行維持）</div>
    <pre id="exportPreview" style="white-space:pre-wrap; color:#dce7f4; margin:6px 0 0 0;"></pre>
  </div>

  <script>
    let data = null;
    let hideNoCandidates = false;
    const FALLBACK_SRC = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 450">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0%" stop-color="#1b2735"/>
            <stop offset="100%" stop-color="#0d1520"/>
          </linearGradient>
        </defs>
        <rect width="800" height="450" fill="url(#g)" />
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
          fill="#cdd7e6" font-family="Inter, \'Noto Sans JP\', sans-serif"
          font-size="40" font-weight="700">イメージ画像</text>
      </svg>
    `);

    async function load() {
      try {
        const res = await fetch("review_data.json");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        data = await res.json();
        document.getElementById("meta").textContent =
          `生成: ${data.generated_at} / ソース: ${data.source}`;
        clearStatus();
        render();
      } catch (e) {
        setStatus("review_data.json を読み込めませんでした。ローカルで開く場合は『JSONを読み込む』で review_data.json を選択してください。詳細: " + e.message);
      }
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }
    function clearStatus() { setStatus(""); }

    function loadFromFile(fileList) {
      if (!fileList || !fileList.length) return;
      const file = fileList[0];
      const reader = new FileReader();
      reader.onload = () => {
        try {
          data = JSON.parse(reader.result);
          document.getElementById("meta").textContent =
            `生成: ${data.generated_at || "N/A"} / ローカル読み込み`;
          clearStatus();
          render();
        } catch (err) {
          setStatus("JSONのパースに失敗しました: " + err.message);
        }
      };
      reader.onerror = () => setStatus("ファイル読み込みに失敗しました。");
      reader.readAsText(file, "utf-8");
    }

    function render() {
      const root = document.getElementById("articles");
      root.innerHTML = "";
      let visibleCount = 0;

      data.articles.forEach(article => {
        const hasCandidates = (article.candidates || []).length > 0;
        if (hideNoCandidates && !hasCandidates) return;
        visibleCount++;

        const card = document.createElement("div");
        card.className = "card";
        card.dataset.id = article.id;

        card.innerHTML = `
          <div class="info">
            <div class="badges">
              <span class="badge">#${article.id}</span>
              <span class="badge">${article.date || ""}</span>
              <span class="badge">${article.source || ""}</span>
              <span class="badge">${hasCandidates ? (article.candidates.length + "候補") : "候補なし"}</span>
            </div>
            <h3>${escapeHtml(article.title || "")}</h3>
            <a href="${article.url}" target="_blank" rel="noreferrer">${article.url}</a>
          </div>
          <div class="images">
            <div class="image-block">
              <h4>現行画像</h4>
              ${article.current_img ? `<img class="current-img img-check" src="${article.current_img}" loading="lazy" alt="current">` : '<div class="meta">No current image</div>'}
              <label class="select"><input type="radio" name="sel-${article.id}" value="">現行のまま</label>
              ${article.current_img ? `<div class="meta" style="word-break:break-all;">${article.current_img}</div>` : ""}
            </div>
            <div class="image-block">
              <h4>候補画像 (${article.candidates ? article.candidates.length : 0})</h4>
              ${article.error ? `<div class="error">Fetch error: ${escapeHtml(article.error)}</div>` : ""}
              ${renderCandidates(article)}
            </div>
          </div>
          <textarea class="note" placeholder="修正指示・メモ (任意)" data-note-for="${article.id}"></textarea>
        `;

        root.appendChild(card);
        // default selection: keep current
        const keep = card.querySelector(`input[name="sel-${article.id}"][value=""]`);
        if (keep) keep.checked = true;
      });

      document.getElementById("counter").textContent = `表示: ${visibleCount} / ${data.articles.length}`;
      updatePreview();
      wireFallbacks();
    }

    function renderCandidates(article) {
      const list = article.candidates || [];
      if (!list.length) {
        return '<div class="meta">候補が見つかりませんでした。</div>';
      }
      const cards = list.map((url, idx) => {
        const shortUrl = url.length > 80 ? url.slice(0, 77) + "..." : url;
        return `
          <label class="candidate">
            <img src="${url}" loading="lazy" alt="candidate">
            <span class="fallback-text" aria-hidden="true">イメージ画像</span>
            <label class="select">
              <input type="radio" name="sel-${article.id}" value="${encodeURIComponent(url)}">
              この画像を使う
            </label>
            <div class="meta" style="word-break:break-all;">${escapeHtml(shortUrl)}</div>
          </label>
        `;
      });
      return `<div class="grid">${cards.join("")}</div>`;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, s => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[s]));
    }

    function gatherSelection() {
      if (!data || !data.articles) return [];
      const rows = [];
      data.articles.forEach(article => {
        const sel = document.querySelector(`input[name="sel-${article.id}"]:checked`);
        const noteEl = document.querySelector(`textarea[data-note-for="${article.id}"]`);
        const note = noteEl ? noteEl.value.trim() : "";
        const selected = sel ? decodeURIComponent(sel.value) : "";
        rows.push({
          id: article.id,
          selected: selected || "",
          note
        });
      });
      return rows;
    }

    function copySelection() {
      if (!data) return setStatus("データが未読込です。『JSONを読み込む』で review_data.json を選択してください。");
      const rows = gatherSelection();
      const json = JSON.stringify(rows, null, 2);
      navigator.clipboard.writeText(json).then(() => {
        alert("選択内容をクリップボードへコピーしました。");
      });
      document.getElementById("exportPreview").textContent = json;
    }

    function exportCsv() {
      if (!data) return setStatus("データが未読込です。『JSONを読み込む』で review_data.json を選択してください。");
      const rows = gatherSelection();
      const header = "id,selected,note";
      const body = rows.map(r => {
        const escaped = [r.id, r.selected, r.note].map(v =>
          `"${(v || "").replace(/"/g, '""')}"`
        );
        return escaped.join(",");
      });
      const csv = [header, ...body].join("\n");
      navigator.clipboard.writeText(csv).then(() => {
        alert("CSVをクリップボードへコピーしました。");
      });
      document.getElementById("exportPreview").textContent = csv;
    }

    function toggleNoCandidates() {
      if (!data) return setStatus("データが未読込です。『JSONを読み込む』で review_data.json を選択してください。");
      hideNoCandidates = !hideNoCandidates;
      render();
    }

    function wireFallbacks() {
      document.querySelectorAll("img.img-check:not([data-fallback])").forEach(img => {
        img.dataset.fallback = "1";
        img.addEventListener("error", () => {
          if (img.dataset.failed) return;
          img.dataset.failed = "1";
          img.src = FALLBACK_SRC;
          img.style.objectFit = "contain";
          const wrap = img.closest(".candidate");
          if (wrap) {
            const label = wrap.querySelector(".fallback-text");
            if (label) label.style.display = "flex";
          }
        }, { once: false });
      });
    }

    function updatePreview() {
      const rows = gatherSelection().filter(r => r.selected);
      document.getElementById("exportPreview").textContent =
        rows.length ? JSON.stringify(rows, null, 2) : "選択された差し替えはまだありません。";
    }

    document.body.addEventListener("change", (e) => {
      if (e.target.matches("input[type=radio]") || e.target.matches("textarea.note")) {
        updatePreview();
      }
    });

    load();
  </script>
</body>
</html>
